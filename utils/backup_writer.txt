package util

import (
	"encoding/json"
	"fmt"
	"log"
	"os"
	"strings"
	"time"

	"github.com/gocql/gocql"
)

type BackupConfig struct {
	Session   *gocql.Session
	Keyspace  string
	Table     string
	OutputDir string
}

// Meta bilgisi için basit yapı
type MetaInfo struct {
	Rows      int       `json:"rows"`
	Timestamp time.Time `json:"timestamp"`
	Duration  string    `json:"duration"`
}

func DumpTable(cfg BackupConfig) error {
	start := time.Now()

	// Output klasörü oluştur
	if err := os.MkdirAll(cfg.OutputDir, 0755); err != nil {
		return fmt.Errorf("output klasörü oluşturulamadı: %w", err)
	}

	// Şemayı al
	schemaQuery := `SELECT column_name, kind, type FROM system_schema.columns WHERE keyspace_name = ? AND table_name = ?`
	iter := cfg.Session.Query(schemaQuery, cfg.Keyspace, cfg.Table).Iter()

	var cols []string
	colTypes := make(map[string]string)

	var name, kind, typ string
	for iter.Scan(&name, &kind, &typ) {
		if kind == "partition_key" || kind == "clustering" || kind == "regular" {
			cols = append(cols, name)
			colTypes[name] = typ
		}
	}
	if err := iter.Close(); err != nil {
		return err
	}

	// schema.cql oluştur
	schemaFile, err := os.Create(cfg.OutputDir + "/schema.cql")
	if err != nil {
		return err
	}
	defer schemaFile.Close()

	schemaParts := []string{}
	for _, col := range cols {
		schemaParts = append(schemaParts, fmt.Sprintf("%s %s", col, colTypes[col]))
	}
	schemaLine := fmt.Sprintf("CREATE TABLE %s.%s (\n  %s\n);", cfg.Keyspace, cfg.Table, strings.Join(schemaParts, ",\n  "))
	schemaFile.WriteString(schemaLine)

	// data.dump oluştur
	dataFile, err := os.Create(cfg.OutputDir + "/data.dump")
	if err != nil {
		return err
	}
	defer dataFile.Close()

	// Verileri yaz
	selectQuery := fmt.Sprintf("SELECT %s FROM %s.%s", strings.Join(cols, ","), cfg.Keyspace, cfg.Table)
	iter = cfg.Session.Query(selectQuery).Iter()

	row := make(map[string]interface{})
	count := 0
	for iter.MapScan(row) {
		var fields []string
		for _, col := range cols {
			v := row[col]
			if v == nil {
				fields = append(fields, `\N`)
			} else {
				val := fmt.Sprintf("%v", v)
				escaped := strings.ReplaceAll(val, "\t", " ") // tab kaçması
				escaped = strings.ReplaceAll(escaped, "\n", " ")
				fields = append(fields, escaped)
			}
		}
		dataFile.WriteString(strings.Join(fields, "\t") + "\n")
		count++
		row = make(map[string]interface{})
	}
	if err := iter.Close(); err != nil {
		return err
	}

	// meta.json oluştur
	meta := MetaInfo{
		Rows:      count,
		Timestamp: time.Now(),
		Duration:  time.Since(start).String(),
	}
	metaBytes, _ := json.MarshalIndent(meta, "", "  ")
	os.WriteFile(cfg.OutputDir+"/meta.json", metaBytes, 0644)

	log.Printf("Backup tamamlandı: %d kayıt yazıldı.\n", count)
	return nil
}
